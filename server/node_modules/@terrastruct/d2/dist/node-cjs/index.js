var g=Object.create;var{getPrototypeOf:k,defineProperty:n,getOwnPropertyNames:h,getOwnPropertyDescriptor:R}=Object,m=Object.prototype.hasOwnProperty;var i=(e,t,s)=>{s=e!=null?g(k(e)):{};let r=t||!e||!e.__esModule?n(s,"default",{value:e,enumerable:!0}):s;for(let o of h(e))if(!m.call(r,o))n(r,o,{get:()=>e[o],enumerable:!0});return r},w=new WeakMap,M=(e)=>{var t=w.get(e),s;if(t)return t;if(t=n({},"__esModule",{value:!0}),e&&typeof e==="object"||typeof e==="function")h(e).map((r)=>!m.call(t,r)&&n(t,r,{get:()=>e[r],enumerable:!(s=R(e,r))||s.enumerable}));return w.set(e,t),t};var j=(e,t)=>{for(var s in t)n(e,s,{get:t[s],enumerable:!0,configurable:!0,set:(r)=>t[s]=()=>r})};var x={};j(x,{D2:()=>f});module.exports=M(x);var d=null;async function p(){if(!d)d={fs:await import("node:fs/promises"),path:await import("node:path"),url:await import("node:url"),worker:await import("node:worker_threads")};return d}async function l(e){let t=await p(),s=t.fs.readFile,{join:r,dirname:o}=t.path,{fileURLToPath:c}=t.url,a=o(c(import.meta.url));try{return await s(r(a,e))}catch(u){if(u.code==="ENOENT")return await s(r(a,"../../../wasm",e.replace("./","")));throw u}}async function y(){let e=await p(),{Worker:t}=e.worker,{join:s,dirname:r}=e.path,{fileURLToPath:o}=e.url,c=r(o(import.meta.url)),a=s(c,"worker.js");return new t(a)}class f{constructor(){this.ready=this.init()}setupMessageHandler(){let e=typeof window==="undefined";return new Promise((t,s)=>{if(e)this.worker.on("message",(r)=>{if(r.type==="ready")t();if(r.type==="error")s(new Error(r.error));if(r.type==="result"&&this.currentResolve)this.currentResolve(r.data);if(r.type==="error"&&this.currentReject)this.currentReject(new Error(r.error))});else this.worker.onmessage=(r)=>{if(r.data.type==="ready")t();if(r.data.type==="error")s(new Error(r.data.error));if(r.data.type==="result"&&this.currentResolve)this.currentResolve(r.data.data);if(r.data.type==="error"&&this.currentReject)this.currentReject(new Error(r.data.error))}})}async init(){this.worker=await y();let e=await l("./wasm_exec.js"),t=await l("./d2.wasm"),s=typeof window==="undefined",r=this.setupMessageHandler();if(s)this.worker.on("error",(o)=>{console.error("Worker (node) encountered an error:",o.message||o)});else this.worker.onerror=(o)=>{console.error("Worker encountered an error:",o.message||o)};return this.worker.postMessage({type:"init",data:{wasm:t,wasmExecContent:s?e.toString():null,wasmExecUrl:s?null:URL.createObjectURL(new Blob([e],{type:"application/javascript"}))}}),r}async sendMessage(e,t){return await this.ready,new Promise((s,r)=>{this.currentResolve=s,this.currentReject=r,this.worker.postMessage({type:e,data:t})})}async compile(e,t={}){let s=typeof e==="string"?{fs:{index:e},options:t}:{...e,options:{...t,...e.options}};return this.sendMessage("compile",s)}async render(e,t={}){return this.sendMessage("render",{diagram:e,options:t})}async encode(e){return this.sendMessage("encode",e)}async decode(e){return this.sendMessage("decode",e)}async version(){return this.sendMessage("version")}async jsVersion(){return this.sendMessage("jsVersion")}}
