#!/usr/bin/env node
var g=["String","Boolean","Date","ObjectID","Number"],y={Array:"Array",Embedded:"Embedded",Mixed:"Mixed"},u=(s,r,e)=>{let[t,...o]=r,n=s.find(i=>i.name===t);if(n||(n={name:t,type:"Embedded",options:{required:!1},children:[]},s.push(n)),o.length===0){let i={required:e.options?.required||!1,unique:e.options?.unique||!1};if(e.options?.ref&&(i.ref=e.options.ref),n.type=e.instance,n.options=i,e.instance==="Array"){let a=e.caster;if(a?.schema){let c=a.schema,d=[];for(let[l,f]of Object.entries(c.paths)){let S=l.split(".");u(d,S,f)}n.children=d}else if(a){let c={name:"item",type:a.instance||"Unknown",options:{required:a.options?.required||!1,unique:a.options?.unique||!1}};a.options?.ref&&(c.options.ref=a.options.ref),n.children=[c]}}if(e.schema){let a=e.schema,c=[];for(let[d,l]of Object.entries(a.paths)){let f=d.split(".");u(c,f,l)}n.children=c}}else n.children||(n.children=[]),u(n.children,o,e)};var b=(s,r)=>{let e=[];for(let t of s){let n=r(t).schema,i=[];for(let[c,d]of Object.entries(n.paths)){let l=c.split(".");u(i,l,d)}let a={instanceMethods:Object.keys(n.methods),staticMethods:Object.keys(n.statics)};e.push({name:t,structure:i,methods:a})}return e},m=[],M=s=>{let r="";return s.forEach(({to:e,from:t,relation:o})=>{r+=`${t} -> ${e}
`}),r},p=(s,r,e)=>{if(!r||r?.length==0)return;let t="";return t+=`${s}: {
shape: sql_table
`,r.forEach(o=>{if(g.includes(o.type))t+=`${o.name}: ${o.type}`,o.options.unique?t+=" {constraint: unique}":o.options.ref?(t+=" {constraint: foreign_key}",m.push({from:`${s}.${o.name}`,to:o.options.ref,relation:"one-to-one"})):o.name=="_id"&&(t+=" {constraint: primary_key}"),t+=`
`;else{let n=Math.random().toString(36).substring(2,8),i=`${o.name}_${n}`;t+=`${o.name}: ${o.type}`,m.push({from:`${s}.${o.name}`,to:i,relation:o.type==y.Embedded?"one-to-one":"one-to-many"}),p(i,o?.children,e)}}),t+=`}
`,e.push(t),e},$=s=>{let r="";return s.forEach(({name:e,structure:t,methods:o})=>{let n=[];p(e,t,n),n[0]=n[0].substring(0,n[0].lastIndexOf(`}
`)),o.instanceMethods.forEach(i=>{n[0]+=`${i}(): instanceMethod
`}),o.staticMethods.forEach(i=>{n[0]+=`${i}(): staticMethod
`}),n[0]+=`}
`,r+=n.join(`

`)}),r+=M(m),r=r.replaceAll("label","_label"),r},h=async(s,r,e)=>{let{D2:t}=await import("@terrastruct/d2"),o=await import("fs"),n=new t,i=await n.compile(s,{options:{layout:"elk",sketch:e?.sketch,forceAppendix:e?.forceAppendix,scale:e?.scale,center:e?.center,pad:e?.pad?e.pad:20},inputPath:""}),a=await n.render(i.diagram,{...i.renderOptions});o.writeFileSync(r,a)},q=async(s,r,e)=>{let t=$(s);await h(t,`full-erd-${r}.svg`,e)},O=async(s,r,e)=>{let t="";for(let o of s){t+=`

${o.name}: {
      shape: sql_table
    }

`;for(let n of o.structure)n.options?.ref&&(t+=`${o.name} -> ${n.options.ref}
`)}await h(t,`minimal-erd-${r}.svg`,e)},A=async(s,r,e)=>{try{console.log("Generating Schema...");let t=b(s,r),o=new Date().toISOString();await Promise.all([O(t,o,e),q(t,o,e)])}catch(t){console.log(t)}};export{A as mongooseToErdMain};
