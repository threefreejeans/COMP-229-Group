#!/usr/bin/env node
"use strict";var M=Object.create;var u=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var q=Object.getOwnPropertyNames;var O=Object.getPrototypeOf,A=Object.prototype.hasOwnProperty;var E=(o,n)=>{for(var e in n)u(o,e,{get:n[e],enumerable:!0})},h=(o,n,e,r)=>{if(n&&typeof n=="object"||typeof n=="function")for(let t of q(n))!A.call(o,t)&&t!==e&&u(o,t,{get:()=>n[t],enumerable:!(r=$(n,t))||r.enumerable});return o};var S=(o,n,e)=>(e=o!=null?M(O(o)):{},h(n||!o||!o.__esModule?u(e,"default",{value:o,enumerable:!0}):e,o)),w=o=>h(u({},"__esModule",{value:!0}),o);var P={};E(P,{mongooseToErdMain:()=>R});module.exports=w(P);var k=["String","Boolean","Date","ObjectID","Number"],I={Array:"Array",Embedded:"Embedded",Mixed:"Mixed"},f=(o,n,e)=>{let[r,...t]=n,s=o.find(i=>i.name===r);if(s||(s={name:r,type:"Embedded",options:{required:!1},children:[]},o.push(s)),t.length===0){let i={required:e.options?.required||!1,unique:e.options?.unique||!1};if(e.options?.ref&&(i.ref=e.options.ref),s.type=e.instance,s.options=i,e.instance==="Array"){let a=e.caster;if(a?.schema){let c=a.schema,d=[];for(let[l,m]of Object.entries(c.paths)){let b=l.split(".");f(d,b,m)}s.children=d}else if(a){let c={name:"item",type:a.instance||"Unknown",options:{required:a.options?.required||!1,unique:a.options?.unique||!1}};a.options?.ref&&(c.options.ref=a.options.ref),s.children=[c]}}if(e.schema){let a=e.schema,c=[];for(let[d,l]of Object.entries(a.paths)){let m=d.split(".");f(c,m,l)}s.children=c}}else s.children||(s.children=[]),f(s.children,t,e)};var j=(o,n)=>{let e=[];for(let r of o){let s=n(r).schema,i=[];for(let[c,d]of Object.entries(s.paths)){let l=c.split(".");f(i,l,d)}let a={instanceMethods:Object.keys(s.methods),staticMethods:Object.keys(s.statics)};e.push({name:r,structure:i,methods:a})}return e},p=[],_=o=>{let n="";return o.forEach(({to:e,from:r,relation:t})=>{n+=`${r} -> ${e}
`}),n},g=(o,n,e)=>{if(!n||n?.length==0)return;let r="";return r+=`${o}: {
shape: sql_table
`,n.forEach(t=>{if(k.includes(t.type))r+=`${t.name}: ${t.type}`,t.options.unique?r+=" {constraint: unique}":t.options.ref?(r+=" {constraint: foreign_key}",p.push({from:`${o}.${t.name}`,to:t.options.ref,relation:"one-to-one"})):t.name=="_id"&&(r+=" {constraint: primary_key}"),r+=`
`;else{let s=Math.random().toString(36).substring(2,8),i=`${t.name}_${s}`;r+=`${t.name}: ${t.type}`,p.push({from:`${o}.${t.name}`,to:i,relation:t.type==I.Embedded?"one-to-one":"one-to-many"}),g(i,t?.children,e)}}),r+=`}
`,e.push(r),e},x=o=>{let n="";return o.forEach(({name:e,structure:r,methods:t})=>{let s=[];g(e,r,s),s[0]=s[0].substring(0,s[0].lastIndexOf(`}
`)),t.instanceMethods.forEach(i=>{s[0]+=`${i}(): instanceMethod
`}),t.staticMethods.forEach(i=>{s[0]+=`${i}(): staticMethod
`}),s[0]+=`}
`,n+=s.join(`

`)}),n+=_(p),n=n.replaceAll("label","_label"),n},y=async(o,n,e)=>{let{D2:r}=await import("@terrastruct/d2"),t=await import("fs"),s=new r,i=await s.compile(o,{options:{layout:"elk",sketch:e?.sketch,forceAppendix:e?.forceAppendix,scale:e?.scale,center:e?.center,pad:e?.pad?e.pad:20},inputPath:""}),a=await s.render(i.diagram,{...i.renderOptions});t.writeFileSync(n,a)},D=async(o,n,e)=>{let r=x(o);await y(r,`full-erd-${n}.svg`,e)},v=async(o,n,e)=>{let r="";for(let t of o){r+=`

${t.name}: {
      shape: sql_table
    }

`;for(let s of t.structure)s.options?.ref&&(r+=`${t.name} -> ${s.options.ref}
`)}await y(r,`minimal-erd-${n}.svg`,e)},R=async(o,n,e)=>{try{console.log("Generating Schema...");let r=j(o,n),t=new Date().toISOString();await Promise.all([v(r,t,e),D(r,t,e)])}catch(r){console.log(r)}};0&&(module.exports={mongooseToErdMain});
